# ChainTrust

Decentralized credit intelligence prototype combining:
- Spring Boot backend (Java 17)
- FastAPI ML scoring microservice (Python)
- Solidity smart contract
- React frontend
- Docker Compose orchestration

## Quick Start
1. Copy `.env.example` to `.env` and fill values:
   ```bash
   cp .env.example .env
   ```
2. Train and export model:
   ```bash
   # Requires labeled outcomes from backend /loan/outcome + /loan/training-data.
   # Script enforces minimum labeled data per class.
   python ml-train/train_model.py --source api
   ```
3. Start stack:
   ```bash
   docker compose up --build
   ```
4. Open:
- Frontend: <http://localhost:3000>
- Backend: <http://localhost:8080>
- ML service docs: <http://localhost:8000/docs>

## Team
- Aamer: ML and DevOps
- Vedant: Blockchain and smart contracts
- Ketan: Java backend and frontend

## API Flow
1. `GET /wallet/{address}` -> extract wallet features.
2. `POST /risk` -> backend calls ML `/predict`.
3. `POST /loan/evaluate` -> applies hard policy rules + ML score + optional on-chain write.
4. `POST /loan/outcome` -> label a past decision as `REPAID` or `DEFAULTED`.
5. `GET /loan/training-data` -> export labeled rows for real model retraining.
6. `POST /auth/register` and `POST /auth/login` -> SQL-backed user account flow.

## Hardhat + Real Chain
Use `contracts/` as a full Hardhat workspace.

One command (Windows PowerShell):
```powershell
.\scripts\start_hardhat_local_chain.ps1
```
One command (bash):
```bash
./scripts/start_hardhat_local_chain.sh
```

Local real chain (Hardhat node):
```bash
cd contracts
npm install
npm run compile
npm run node
```
In another terminal:
```bash
cd contracts
npm run deploy:local
```
Then set root `.env`:
```env
ETH_RPC_URL=http://host.docker.internal:8545
BLOCKCHAIN_ENABLED=true
BLOCKCHAIN_CHAIN_ID=31337
CONTRACT_ADDRESS=<deployed_address_from_contracts/deployments/localhost.json>
BLOCKCHAIN_PRIVATE_KEY=ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```
Restart:
```bash
docker compose up --build -d
```

Sepolia deployment is also supported:
```bash
cd contracts
npm run deploy:sepolia
```
Requires `HARDHAT_SEPOLIA_RPC_URL` and `HARDHAT_DEPLOYER_PRIVATE_KEY`.
Use `.env.sepolia.example` as the template for backend/frontend deployment variables.
Note: deployer must hold Sepolia ETH for deployment gas.

Automated PowerShell workflow (deploy + wire `.env`):
```powershell
.\scripts\deploy_sepolia_and_wire_env.ps1
```

## Real Retraining Workflow
1. Run `POST /loan/evaluate` during normal usage.
2. When repayment/default outcome is known, call `POST /loan/outcome`.
3. Retrain with `python ml-train/train_model.py --source api`.
4. Restart stack so backend picks up `ml-service/model/policy_thresholds.json`.

## Bootstrap Labels (Local)
For local development you can bootstrap the minimum labeled set (10 per class):
```bash
python scripts/collect_labeled_outcomes.py --backend-url http://localhost:8080 --target-per-class 10
python ml-train/train_model.py --source api
docker compose up --build -d
```

For larger real datasets from `eth_addresses.csv`:
```bash
python scripts/bootstrap_labels_from_eth_csv.py --csv eth_addresses.csv --backend-url http://localhost:8080 --target-per-class 300 --account-type all
python ml-train/train_model.py --source api
```
By default, bootstrap excludes wallet addresses already present in `/loan/training-data` to avoid duplicate relabeling.

## Notes
- `ml-service/model/model.pkl` must exist for normal ML scoring.
- `ml-service/model/policy_thresholds.json` is generated by training and consumed by backend policy.
- `ml-service/model/metrics.json` is generated by training with CV + held-out leakage-safe metrics.
- Auth data is persisted in PostgreSQL tables `app_users` and `user_wallets` with indexed normalized fields.
- If ML service is unavailable, backend defaults to `HIGH` risk.
- On-chain storage should persist only hashes, not raw PII.
